<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Paramètres</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- (Garde ton CSS inchangé, j'ai repris exactement le tien) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #f5f7fa; --bg-secondary: #ffffff;
            --text-primary: #333333; --text-secondary: #666666;
            --text-tertiary: #999999; --border-color: #f0f0f0;
            --shadow-sm: 0 2px 10px rgba(0,0,0,0.08);
            --shadow-md: 0 2px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
            --navbar-height: 60px;
            --primary-color: #ffd700; --primary-dark: #e6c200;
            --primary-gradient: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-primary); padding-top: var(--navbar-height); transition: background 0.3s ease, color 0.3s ease; }
        body.dark-mode { --bg-primary: #1a1a1a; --bg-secondary:#2d2d2d; --text-primary:#e0e0e0; --text-secondary:#b0b0b0; --text-tertiary:#808080; --border-color:#404040; --shadow-sm:0 2px 10px rgba(0,0,0,0.3); --shadow-md:0 2px 15px rgba(0,0,0,0.4); --shadow-lg:0 4px 20px rgba(0,0,0,0.5); }
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: var(--navbar-height); background: var(--primary-gradient); box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3); padding: 0 15px; display:flex; justify-content:space-between; align-items:center; z-index:1000; backdrop-filter: blur(10px); }
        .navbar-left { color: #1a1a1a; font-size:22px; font-weight:bold; text-shadow:2px 2px 4px rgba(0,0,0,0.1); letter-spacing:0.5px; flex-shrink:0; }
        .navbar-center { display:flex; align-items:center; }
        .theme-toggle { background: rgba(0,0,0,0.1); border:2px solid rgba(0,0,0,0.2); border-radius:50%; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.3s ease; backdrop-filter: blur(10px); }
        .theme-toggle:hover { background: rgba(0,0,0,0.2); transform: scale(1.05) rotate(15deg); }
        .theme-toggle i { font-size:18px; color:#1a1a1a; transition:transform 0.3s ease; }
        .navbar-right { display:flex; gap:20px; align-items:center; }
        .nav-item { display:flex; flex-direction:column; align-items:center; gap:2px; cursor:pointer; color:#1a1a1a; transition:all 0.3s ease; text-decoration:none; position:relative; padding:5px 8px; border-radius:8px; min-width:50px; }
        .nav-item:hover { background: rgba(0,0,0,0.1); transform: translateY(-2px); }
        .page-title { position: fixed; top: var(--navbar-height); left:50%; transform:translateX(-50%); background:var(--bg-secondary); padding:8px 25px; border-radius:0 0 12px 12px; box-shadow:var(--shadow-sm); z-index:999; font-size:16px; font-weight:bold; color:var(--text-primary); transition:all 0.3s ease; max-width:90%; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .settings-container { max-width:600px; margin:40px auto; padding:20px; }
        .settings-section { background:var(--bg-secondary); border-radius:15px; padding:20px; margin-bottom:30px; box-shadow:var(--shadow-md); }
        .settings-section h2 { color:var(--text-primary); font-size:18px; margin-bottom:15px; display:flex; align-items:center; gap:10px; }
        .settings-section h2 i { color:var(--primary-color); }
        .form-group { margin-bottom:15px; }
        .form-group label { display:block; color:var(--text-secondary); font-size:14px; margin-bottom:5px; }
        .form-group input { width:100%; padding:12px; border:2px solid var(--border-color); border-radius:8px; background:var(--bg-primary); color:var(--text-primary); font-size:16px; transition:all 0.3s ease; }
        .form-group input:focus { outline:none; border-color:var(--primary-color); box-shadow:0 0 0 3px rgba(255,215,0,0.1); }
        .submit-btn { width:100%; padding:15px; background:var(--primary-gradient); border:none; border-radius:12px; color:#1a1a1a; font-size:16px; font-weight:600; cursor:pointer; transition:all 0.3s ease; box-shadow:0 4px 15px rgba(255,215,0,0.3); display:flex; align-items:center; justify-content:center; gap:8px; }
        .delete-section { border:2px solid #ff4757; border-radius:15px; padding:20px; background: rgba(255,71,87,0.05); }
        .verification-string { background:var(--bg-primary); padding:10px; border-radius:8px; font-family:monospace; white-space:pre-wrap; word-break:break-all; user-select:none; margin-bottom:15px; color:var(--text-primary); }
        .no-copy-input { user-select:none; }
        .hidden { display:none; }
        .error-message { color:#ff4757; font-size:14px; margin-top:5px; display:none; }
        .success-message { color:#28a745; font-size:14px; margin-top:5px; display:none; }
        @media (max-width:768px) { .settings-container { padding:15px; margin:30px auto; } .settings-section { padding:15px; } .submit-btn { padding:12px; font-size:14px; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">Héritage Spirituelle</div>
        <div class="navbar-center">
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon" id="theme-icon"></i>
            </button>
        </div>
        <div class="navbar-right">
            <div class="nav-item" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i>
                <span>Retour</span>
            </div>
        </div>
    </nav>

    <div class="page-title">Paramètres</div>

    <div class="settings-container">
        <div class="settings-section">
            <h2><i class="fas fa-user-edit"></i> Modifier le nom et prénom</h2>
            <form id="update-profile-form">
                <div class="form-group">
                    <label for="prenom">Prénom</label>
                    <input type="text" id="prenom" required>
                </div>
                <div class="form-group">
                    <label for="nom">Nom</label>
                    <input type="text" id="nom" required>
                </div>
                <div class="form-group">
                    <label for="current-password">Mot de passe actuel (obligatoire)</label>
                    <input type="password" id="current-password" required>
                </div>
                <button type="submit" class="submit-btn"><i class="fas fa-save"></i> Enregistrer les modifications</button>
                <p class="error-message" id="update-error"></p>
                <p class="success-message" id="update-success"></p>
            </form>
        </div>

        <div class="settings-section delete-section">
            <h2><i class="fas fa-trash-alt"></i> Supprimer le compte</h2>
            <p>Pour supprimer votre compte, veuillez taper exactement la chaîne suivante (sans copier-coller) :</p>
            <div class="verification-string" id="verification-string">₽ o hn ₹ ₿₱ ¶v; ”(t“ &gt;&lt; æ₿β ϟϛχ ποιι θετψψ ηφσϟνχ ζδσξλππ φδρψη κξγφϛ βνμκ ϡλλπο γφζϛϛφθσ ∩∋∈→8≡⊷ εε∨ ⊥∡⌀∞∞ℝℕ∇ 23ϡ⊗⊙⊖⊕∀789↕↑↔∨∧⌈⌉∡⌀√</div>
            <div class="form-group">
                <label for="verification-input">Taper la chaîne ici :</label>
                <input type="text" id="verification-input" class="no-copy-input" onpaste="return false" oncopy="return false" required>
            </div>
            <button id="verify-btn" class="submit-btn" style="background: linear-gradient(135deg, #ff4757 0%, #e04250 100%); color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);"><i class="fas fa-check"></i> Vérifier</button>
            <div id="delete-confirm" class="hidden" style="margin-top:15px;">
                <div class="form-group">
                    <label for="delete-password">Confirmez avec votre mot de passe :</label>
                    <input type="password" id="delete-password" required>
                </div>
                <button id="delete-btn" class="submit-btn" style="background: linear-gradient(135deg, #ff4757 0%, #e04250 100%); color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);"><i class="fas fa-trash"></i> Supprimer définitivement</button>
            </div>
            <p class="error-message" id="delete-error"></p>
            <p class="success-message" id="delete-success"></p>
        </div>
    </div>

    <!-- Assure-toi que supabaseClient.js définit window.supabaseClient = { supabase, getCurrentUser, getUserProfile } si tu l'utilises -->
    <script src="supabaseClient.js"></script>

    <script>
        // fallback robust pour récupérer supabase et helpers
        const { supabase, getCurrentUser, getUserProfile } = window.supabaseClient || {};

        // fallback if supabase not provided by supabaseClient.js (try global creation)
        // ATTENTION : si tu utilises une clé publique et url, préfère les définir dans supabaseClient.js
        if (!supabase && window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
            window.supabase = window.supabaseClient = window.supabaseClient || {};
            window.supabase = supabase = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
        }

        let currentUser = null;
        let userProfile = null;

        // exact same string que dans l'UI pour vérification
        const verificationString = document.getElementById('verification-string').textContent.trim();

        // theme
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const body = document.body;
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            themeIcon.classList.replace('fa-moon', 'fa-sun');
        }
        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                themeIcon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'light');
            }
        });

        // --- Helpers robustes pour récupérer user et profil ---
        async function getCurrentUserSafe() {
            // si helper fourni par supabaseClient.js
            if (typeof getCurrentUser === 'function') {
                try {
                    const u = await getCurrentUser();
                    // certains helpers renvoient { user } ou directement l'user
                    if (u && u.user) return u.user;
                    return u;
                } catch (e) {
                    console.warn('getCurrentUser() helper failed, fallback to supabase.auth.getUser()', e);
                }
            }
            // fallback direct supabase
            if (supabase && supabase.auth && typeof supabase.auth.getUser === 'function') {
                const { data, error } = await supabase.auth.getUser();
                if (error) throw error;
                return data.user;
            }
            return null;
        }

        async function getUserProfileSafe(userId) {
            if (!userId) return null;
            if (typeof getUserProfile === 'function') {
                try {
                    const profile = await getUserProfile(userId);
                    // some helpers return { data } or profile directly
                    if (profile && profile.data) return profile.data;
                    return profile;
                } catch (e) {
                    console.warn('getUserProfile() helper failed, fallback to query', e);
                }
            }
            // fallback direct DB query
            const { data, error } = await supabase
                .from('users_profile')
                .select('user_id, prenom, nom, role')
                .eq('user_id', userId)
                .maybeSingle();
            if (error) throw error;
            return data;
        }

        // vérification mot de passe (ré-authentification basique)
        async function verifyPassword(email, password) {
            // NOTE: signInWithPassword créera une session si réussi.
            // c'est acceptable pour une ré-authentification simple côté client.
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            if (error) throw error;
            return data;
        }

        async function init() {
            try {
                const u = await getCurrentUserSafe();
                if (!u) {
                    window.location.href = 'connexion.html';
                    return;
                }
                currentUser = u;
                // récupère le profil (table users_profile) via user_id
                userProfile = await getUserProfileSafe(currentUser.id);

                if (userProfile) {
                    document.getElementById('prenom').value = userProfile.prenom || '';
                    document.getElementById('nom').value = userProfile.nom || '';
                }
            } catch (err) {
                console.error('Init error:', err);
                // si erreur, redirige vers connexion (optionnel)
                // window.location.href = 'connexion.html';
            }
        }

        // --- Update profile ---
        document.getElementById('update-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const prenom = document.getElementById('prenom').value.trim();
            const nom = document.getElementById('nom').value.trim();
            const password = document.getElementById('current-password').value;
            const errorElem = document.getElementById('update-error');
            const successElem = document.getElementById('update-success');

            errorElem.style.display = 'none';
            successElem.style.display = 'none';

            if (!password) {
                errorElem.textContent = 'Le mot de passe actuel est obligatoire.';
                errorElem.style.display = 'block';
                return;
            }

            if (!currentUser) {
                errorElem.textContent = 'Utilisateur non connecté.';
                errorElem.style.display = 'block';
                return;
            }

            try {
                // Ré-authentifier rapidement
                await verifyPassword(currentUser.email, password);

                // Mettre à jour la table users_profile (colonne user_id)
                const { data: updated, error: updateError } = await supabase
                    .from('users_profile')
                    .update({ prenom, nom })
                    .eq('user_id', currentUser.id)
                    .select()
                    .maybeSingle();

                if (updateError) throw updateError;

                successElem.textContent = 'Profil mis à jour avec succès.';
                successElem.style.display = 'block';
                // mettre à jour la variable locale
                userProfile = updated || userProfile;
                // clear password field
                document.getElementById('current-password').value = '';
            } catch (err) {
                console.error(err);
                errorElem.textContent = err.message || 'Une erreur est survenue lors de la mise à jour.';
                errorElem.style.display = 'block';
            }
        });

        // --- Vérification de la chaîne pour suppression ---
        document.getElementById('verify-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const input = document.getElementById('verification-input').value.trim();
            const errorElem = document.getElementById('delete-error');
            errorElem.style.display = 'none';

            if (input === verificationString) {
                document.getElementById('delete-confirm').classList.remove('hidden');
            } else {
                errorElem.textContent = 'La chaîne ne correspond pas. Veuillez réessayer.';
                errorElem.style.display = 'block';
            }
        });

        // --- Suppression du compte (profil uniquement côté DB) ---
        document.getElementById('delete-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const password = document.getElementById('delete-password').value;
            const errorElem = document.getElementById('delete-error');
            const successElem = document.getElementById('delete-success');

            errorElem.style.display = 'none';
            successElem.style.display = 'none';

            if (!password) {
                errorElem.textContent = 'Le mot de passe est obligatoire.';
                errorElem.style.display = 'block';
                return;
            }
            if (!currentUser) {
                errorElem.textContent = 'Utilisateur non connecté.';
                errorElem.style.display = 'block';
                return;
            }

            try {
                // Ré-authentification
                await verifyPassword(currentUser.email, password);

                // Supprime uniquement la ligne de users_profile (la suppression complète de l'auth utilisateur requiert une action côté serveur/admin)
                const { error: deleteError } = await supabase
                    .from('users_profile')
                    .delete()
                    .eq('user_id', currentUser.id);

                if (deleteError) throw deleteError;

                // Déconnexion locale
                await supabase.auth.signOut();

                successElem.textContent = 'Profil supprimé localement. Si tu souhaites supprimer l\'utilisateur Auth (Supabase), il faut une requête serveur admin.';
                successElem.style.display = 'block';

                // redirection après un petit délai
                setTimeout(() => { window.location.href = 'connexion.html'; }, 1500);
            } catch (err) {
                console.error('Delete error:', err);
                errorElem.textContent = err.message || 'Une erreur est survenue lors de la suppression.';
                errorElem.style.display = 'block';
            }
        });

        // Initialise la page
        init();
    </script>
</body>
</html>
